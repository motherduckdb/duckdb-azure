# name: test/sql/cloud/spn_auth.test
# description: test azure extension with service principal authentication
# group: [cloud]

require azure

require parquet

require-env AZURE_CLIENT_ID

require-env AZURE_CLIENT_SECRET

require-env AZURE_TENANT_ID

require-env AZ_STORAGE_ACCOUNT

require-env AZ_DATA_DIR


statement error
SELECT count(*) FROM 'azure://${AZ_DATA_DIR}/l.parquet';
----
Invalid Input Error: No valid Azure credentials found!

statement ok
CREATE SECRET s1 (
    TYPE AZURE,
    PROVIDER SERVICE_PRINCIPAL,
    TENANT_ID '${AZURE_TENANT_ID}',
    CLIENT_ID '${AZURE_CLIENT_ID}',
    CLIENT_SECRET '${AZURE_CLIENT_SECRET}',
    ACCOUNT_NAME '${AZ_STORAGE_ACCOUNT}'
)

query I
SELECT count(*) FROM 'az://${AZ_DATA_DIR}/l.parquet';
----
60175

query I
FROM glob('az://${AZ_DATA_DIR}/*.parquet');
----
az://${AZ_DATA_DIR}/l.parquet
