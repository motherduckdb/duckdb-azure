# name: test/sql/cloud/vfs_ops.test
# description: test azure extension vfs ops
# group: [cloud]

# Require statement will ensure this test is run with this extension loaded
require azure

require-env ABFSS_STORAGE_ACCOUNT

require-env AZ_STORAGE_ACCOUNT

require-env AZURE_AUTH_ENV 1

statement ok
CREATE OR REPLACE SECRET abfss_authn (
	TYPE AZURE,
	PROVIDER CREDENTIAL_CHAIN,
	ACCOUNT_NAME '${ABFSS_STORAGE_ACCOUNT}',
	SCOPE 'abfss://'
);

statement ok
CREATE OR REPLACE SECRET az_authn (
	TYPE AZURE,
	PROVIDER CREDENTIAL_CHAIN,
	ACCOUNT_NAME '${AZ_STORAGE_ACCOUNT}',
	SCOPE 'az://'
);

foreach proto abfss az

# This test only confirms that FileExists gets called (not whether it's correct), and it's brittle at that.
statement error
INSTALL '${proto}://invalid-container/dir/ext.duckdb_extension';
----
container does not exist

# confirm file not exist
statement error
INSTALL '${proto}://duckdblabs-data/common/azure_data/non-existent.duckdb_extension';
----
<REGEX>:.*(blob|file) does not exist.*

# and confirm file exists (doesn't load, but unnecessary to the test)
statement error
INSTALL '${proto}://duckdblabs-data/common/azure_data/l.csv';
----
file is not a DuckDB extension

endloop
