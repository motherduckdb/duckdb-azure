# name: test/sql/cloud/network_test.test
# description: confirm HTTP stats fall within expected values
# group: [cloud]

require azure

require parquet

require-env AZURE_STORAGE_ACCOUNT

require-env DUCKDB_AZ_DATA_DIR


statement ok
set allow_persistent_secrets=false

statement error
SELECT count(*) FROM 'azure://${DUCKDB_AZ_DATA_DIR}/l.parquet';
----
Invalid Input Error: No valid Azure credentials found!

statement ok
CREATE SECRET az1 (
    TYPE AZURE,
    PROVIDER CREDENTIAL_CHAIN,
    CHAIN 'env;cli',
    ACCOUNT_NAME '${AZURE_STORAGE_ACCOUNT}'
)

# Enable http info for the explain analyze statement
statement ok
SET azure_http_stats = true;

query II
EXPLAIN ANALYZE SELECT sum(l_orderkey) FROM 'az://${DUCKDB_AZ_DATA_DIR}/l.parquet';
----
analyzed_plan	<REGEX>:.*HTTP Stats.*in\: \d[.]\d MiB.*\#HEAD\: [23].*GET\: [0-3].*PUT\: 0.*\#POST\: 0.*

# Redoing query should still result in same request count
query II
EXPLAIN ANALYZE SELECT sum(l_orderkey) FROM 'az://${DUCKDB_AZ_DATA_DIR}/l.parquet';
----
analyzed_plan	<REGEX>:.*HTTP Stats.*in\: \d[.]\d MiB.*\#HEAD\: [23].*GET\: [0-3].*PUT\: 0.*\#POST\: 0.*
